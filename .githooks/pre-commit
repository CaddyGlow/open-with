#!/usr/bin/env bash
# Pre-commit hook for open-with project

set -e

echo "ğŸ” Running pre-commit checks..."

# 1. Check formatting
echo "ğŸ“ Checking code formatting..."
if ! cargo fmt -- --check; then
    echo "âŒ Code formatting issues found. Running 'cargo fmt' to fix..."
    cargo fmt
    echo "âœ… Code formatted. Please review and stage the changes."
    exit 1
fi

# 2. Run clippy
echo "ğŸ” Running clippy..."
if ! cargo clippy -- -D warnings -D clippy::all -D clippy::pedantic -A clippy::module_name_repetitions -A clippy::struct_excessive_bools; then
    echo "âŒ Clippy found issues. Please fix them before committing."
    exit 1
fi

# 3. Run tests
echo "ğŸ§ª Running tests..."
if ! cargo test --quiet; then
    echo "âŒ Tests failed. Please fix them before committing."
    exit 1
fi

# 4. Check documentation
echo "ğŸ“š Checking documentation..."
if ! RUSTDOCFLAGS="-D warnings" cargo doc --all-features --no-deps --document-private-items --quiet; then
    echo "âŒ Documentation issues found. Please fix them before committing."
    exit 1
fi

# 5. Run cargo-deny
echo "ğŸ”’ Running security and license checks..."
if ! cargo deny check; then
    echo "âŒ cargo-deny found issues. Please fix them before committing."
    exit 1
fi

# 6. Check for build
echo "ğŸ”¨ Checking release build..."
if ! cargo build --release --quiet; then
    echo "âŒ Release build failed. Please fix it before committing."
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
