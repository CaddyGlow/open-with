#!/usr/bin/env bash
set -euo pipefail

echo "Running pre-commit checks..."

run() {
  echo "+ $*"
  "$@"
}

if ! cargo fmt --all -- --check; then
  echo "Formatting failed. Run 'cargo fmt' to apply fixes."
  exit 1
fi

run cargo clippy --workspace --all-targets --all-features
run cargo test --workspace --all-features
run cargo build --workspace --all-features --release

if [[ "${PRECOMMIT_DOCS:-0}" == "1" ]]; then
  run cargo doc --workspace --all-features --no-deps
fi

if [[ "${PRECOMMIT_AUDIT:-0}" == "1" ]]; then
  run cargo audit --deny warnings
  run cargo deny check licenses
fi

if [[ "${PRECOMMIT_COVERAGE:-0}" == "1" ]]; then
  run cargo coverage
fi

echo "Pre-commit checks completed."
